Notebook OCR + Search Pipeline (test/test.ipynb)
=================================================

Flow (high level)
- Load INPUT_FILE (default image2tab.webp) and CLI args -> preprocess image -> Tesseract OCR -> OCR_TEXT
- Detect language + light token preview -> keyword classification -> doc_type + status decision (OK/REVIEW)
- Compute layout fingerprint + quality gate -> maybe force status REVIEW + assign template_id
- If status OK: chunk OCR_TEXT, dedupe corpus, build/reset Elasticsearch index, index chunks
- Retrieve chunks for queries -> apply regex extractors to build answers with audit trail

1) Input, CLI and defaults
- INPUT_FILE optional string; default relative to notebook dir.
- argparse arguments for lang, OCR flags (oem, psm, dpi, tessdata_dir, user_words/patterns, whitelist/blacklist) and preprocessing tunables (contrast, sharpness, brightness, upscale, gamma, pad, threshold, median, unsharp, invert, autocontrast, equalize, auto_rotate, otsu) plus passthrough --config.*
- Ensures Tesseract binary present and warns if requested languages missing.

2) Preprocessing (preprocess_image)
- Convert to grayscale; optional auto-rotate via pytesseract OSD.
- Optional invert; padding; autocontrast; histogram equalize.
- Upscale by factor; gamma correction; brightness/contrast/sharpness adjustments; unsharp mask; median filter.
- Binarization: fixed threshold or Otsu (needs numpy). Returns PIL image.
- Shows original and preprocessed images when SHOW_PREPROCESSED=True.

3) OCR
- build_config assembles Tesseract flags (oem/psm/dpi/tessdata_dir/user_words/user_patterns + extra config list and whitelist/blacklist).
- Runs pytesseract.image_to_string on preprocessed image with lang (default fra) -> OCR_TEXT printed.

4) Language detect & token preview
- langdetect on first 2000 chars -> doc_lang (fallback fr).
- spaCy fr_core_news_sm (light pipeline: tokenizer only) splits sentences via regex and prints tokens per sentence (min length 20 chars).

5) Keyword classification (deterministic)
- KEYWORDS dict defines cues for FACTURE, BON_DE_COMMANDE, CONTRAT, ARTICLE, FORMULAIRE (FR + EN variants, OCR typos included).
- spaCy tokenizer builds uppercase tokens; counts keyword hits per class; stores matched keywords.
- detected_class = argmax scores; prints doc_lang, class, per-class scores and matched keywords.

6) Stable JSON decision + routing (result)
- THRESHOLD=3, MARGIN=2. If top_score=0 -> UNKNOWN/REVIEW. Else status OK only if top_score >= THRESHOLD AND gap >= MARGIN; otherwise REVIEW. doc_type_final = best class.
- language_hint normalized to fr/en/mix from doc_lang.
- result includes doc_id (UUID), doc_type, status, scores, matched_keywords, threshold/margin, language_hint, decision_debug.
- route_rules loader merges optional rules: common + doc_type + template-specific YAML/JSON under rules/. If none found, falls back to minimal empty ruleset. result.routing stores ruleset + metadata.

7) Layout fingerprint + quality gate
- Uses prepped image: orientation via pytesseract OSD; optional rotation applied. Skew estimated with OpenCV Hough lines; table presence counted (h_lines/v_lines). OCR confidence via pytesseract.image_to_data; text density (alnum per MP).
- layout_fingerprint stores page_count, sizes, orientation_deg, skew_angle_deg list, has_table flags, line counts, text_density, ocr_confidence, aspect_ratio.
- grid_type heuristic: ITEM_TABLE if many H & V lines, BOXED_FORM if many H few V, else NONE.
- quality_gate flags REVIEW if low OCR conf (<75), too few words (<40), high skew (>5° abs), or low text density (<120 chars/MP). If triggered, result.status forced to REVIEW with quality_gate_enforced note.
- template_signature buckets size/ratio/line counts; template_id = sha256 hash prefix; attached to result + metadata_summary; routing updated with template_id and optionally re-routed ruleset.

8) Chunking (audit-ready)
- Constants: CHUNK_SIZE=800 chars, OVERLAP=150, EXCERPT_LEN=220.
- clean_text_stable normalizes whitespace; chunk_text_fixed slides window with overlap, skipping tiny chunks.
- build_chunks_for_pages adds chunk_id (UUID16), page number, start/end offsets, char_len, text, excerpt.
- If result.status == REVIEW -> chunking skipped and chunks=[] with reason. Otherwise OCR_TEXT (single page) is chunked and stored in result, with preview of first two chunks printed.

9) Corpus management & Elasticsearch indexing/search
- Maintains in-memory CORPUS list. Each doc gets source_hash (bag-of-words SHA-256 over normalized text top 250 terms) for dedup; prior corpus deduped first. REVIEW docs are excluded from index.
- ES settings: ES_URL http://127.0.0.1:9200, index doc_chunks_v1, reset on each build (ES_RESET_INDEX_EACH_BUILD=True), timeout 30s.
- Mapping stores doc_id/doc_type/template_id/language_hint/status/source_hash/page/chunk_id/text/excerpt.
- build_index collects chunks from CORPUS, resets/creates index, bulk indexes with _id "doc_id::chunk_id".
- retrieve(query, top_k, filters, dedup flags) runs simple_query_string on text with AND default, applies filters (status defaults to OK), dedups by source_hash and excerpt, returns top_k hits with score.
- test_query default "montant à payer"; build_index then retrieve(... doc_type=FACTURE) prints hits.

10) Regex extractors (invoice fields)
- Utility: strip_accents, norm (lower + spacing), parse_number_pair (normalizes decimal), normalize_date_iso (dd/mm/yyyy or mm/dd/yyyy -> ISO), telephone normalization.
- INVOICE_RULES regex for montant_a_payer_ttc, montant_a_payer, timbre, total_ttc, date, numero_facture, telephone. extract_invoice_fields returns fields + audit (rule_id + match_raw) using first match per rule with precedence (montant_a_payer_ttc before montant_a_payer).

11) Q&A wrapper
- build_answer takes query + hits: if fields found, formats human-readable lines (telephone, montant, timbre, date, numero_facture); else lists passages.
- ask(query, mode=fast|normal, filters, top_k) enforces status OK filter, calls retrieve + extract_invoice_fields, returns dict {query, mode, filters_applied, answer, fields, audit, sources}.
- Final cell sets q=test_query and prints JSON response.

12) Database schema view
- Mermaid ER diagram rendered in HTML cell; shows tables ROLES, USERS, DOMAINS, RULE_CONFIGS, APIS, API_KEYS, DOCUMENTS, FILE_STORAGE, EXTRACTIONS, QUALITY_GATE_LOGS, AUDIT_LOGS with relations.

External dependencies / services
- Requires Tesseract binary with language data; Python packages: pillow, pytesseract, numpy, opencv-python, spacy, langdetect, elasticsearch, IPython display; spaCy models fr_core_news_sm (and optionally en_core_web_sm). Elasticsearch must be running locally on 127.0.0.1:9200.
- Globals used across cells: INPUT_FILE, args, prepped/original images, OCR_TEXT, result dict, CORPUS list, _es client, _chunks_meta.

Deterministic guards
- Status REVIEW stops chunking and ES indexing. ES indexing also skips REVIEW docs even if already in CORPUS.
- Source deduping prevents duplicate documents by hashed bag-of-words.
- Quality gate ensures low-quality OCR flagged before downstream steps.
