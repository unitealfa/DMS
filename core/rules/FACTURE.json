{
  "ruleset_id": "FACTURE_EXTRACT_V3_FR_EN_AR",
  "extractors": {
    "numero_facture": {
      "rule_id": "INV_NUM_02",
      "pattern": "(?xim)\\b(?:facture\\s*(?:n(?:o|°|º)?|num(?:e|é)?ro|number|no\\.?|#)|(?:n(?:o|°|º)?|num(?:e|é)?ro)\\s*de\\s*facture|invoice\\s*(?:number|no\\.?|#)|رقم\\s*الفاتورة|فاتورة\\s*(?:رقم|#)?|الفاتورة\\s*(?:رقم|#)?)\\b[\\s\\t:;=\\-–—#]*([A-Za-z0-9٠-٩ء-ي][A-Za-z0-9٠-٩ء-ي._\\/-]{0,30}(?:[ \\t][A-Za-z0-9٠-٩ء-ي._\\/-]{1,30}){0,2})",
      "group": 1,
      "type": "string",
      "flags": ["IGNORECASE", "MULTILINE"],
      "many": true,
      "nlp": {
        "use_pos": false,
        "pos_patterns": [],
        "use_ner": false,
        "ner_labels": [],
        "confidence_threshold": 0.0
      },
      "min_confidence": 0.0,
      "apply_post_filters": true,
      "post_filters": [
        "trim_spaces",
        "strip_trailing_punct",
        "normalize_arabic_indic_digits",
        "reject_pure_date_like",
        "reject_common_labels_as_value",
        "normalize_invoice_number"
      ]
    },

    "date_facture": {
      "rule_id": "INV_DATE_02",
      "pattern": "(?xim)\\b(?:date\\s*facture|facture\\s*date|invoice\\s*date|date\\s*d['’]?\\s*(?:emission|émission|edition|édition)|تاريخ\\s*الفاتورة|تاريخ\\s*الإصدار|تاريخ\\s*الاصدار|تاريخ\\s*التحرير)\\b[\\s\\t:;=\\-–—]*((?:(?:[0-3]?[0-9٠-٩])[\\/\\-.](?:[0-1]?[0-9٠-٩])[\\/\\-.](?:[12١٢][0-9٠-٩]{3}))|(?:(?:[12١٢][0-9٠-٩]{3})[\\/\\-.](?:[0-1]?[0-9٠-٩])[\\/\\-.](?:[0-3]?[0-9٠-٩])))",
      "group": 1,
      "type": "date",
      "flags": ["IGNORECASE", "MULTILINE"],
      "many": true,
      "nlp": {
        "use_pos": false,
        "pos_patterns": [],
        "use_ner": true,
        "ner_labels": ["DATE"],
        "confidence_threshold": 0.0
      },
      "min_confidence": 0.0,
      "apply_post_filters": true,
      "post_filters": [
        "strip_trailing_punct",
        "normalize_arabic_indic_digits",
        "normalize_date_separators",
        "normalize_date_iso",
        "validate_calendar_date"
      ]
    },

    "date_echeance": {
      "rule_id": "INV_DUE_DATE_02",
      "pattern": "(?xim)\\b(?:date\\s*d['’]?\\s*echeance|date\\s*d['’]?\\s*échéance|echeance|échéance|due\\s*date|payment\\s*due\\s*date|date\\s*limite\\s*de\\s*paiement|تاريخ\\s*الاستحقاق|تاريخ\\s*الدفع|آخر\\s*أجل\\s*للدفع|اخر\\s*اجل\\s*للدفع|تاريخ\\s*استحقاق\\s*الدفع)\\b[\\s\\t:;=\\-–—]*((?:(?:[0-3]?[0-9٠-٩])[\\/\\-.](?:[0-1]?[0-9٠-٩])[\\/\\-.](?:[12١٢][0-9٠-٩]{3}))|(?:(?:[12١٢][0-9٠-٩]{3})[\\/\\-.](?:[0-1]?[0-9٠-٩])[\\/\\-.](?:[0-3]?[0-9٠-٩])))",
      "group": 1,
      "type": "date",
      "flags": ["IGNORECASE", "MULTILINE"],
      "many": true,
      "nlp": {
        "use_pos": false,
        "pos_patterns": [],
        "use_ner": true,
        "ner_labels": ["DATE"],
        "confidence_threshold": 0.0
      },
      "min_confidence": 0.0,
      "apply_post_filters": true,
      "post_filters": [
        "strip_trailing_punct",
        "normalize_arabic_indic_digits",
        "normalize_date_separators",
        "normalize_date_iso",
        "validate_calendar_date"
      ]
    },

    "montant_ht": {
      "rule_id": "INV_AMOUNT_HT_02",
      "pattern": "(?xim)^\\s*(?:montant\\s*ht|total\\s*ht|total\\s*hors\\s*taxe|montant\\s*hors\\s*taxe|sous[- ]?total|subtotal|sub-total|amount\\s*before\\s*tax|total\\s*excl(?:\\.?|uding)?\\s*tax|المبلغ\\s*(?:دون|قبل)\\s*الضريبة|ال(?:إ|ا)جمالي\\s*(?:دون|قبل)\\s*الضريبة|المجموع\\s*(?:دون|قبل)\\s*الضريبة|المبلغ\\s*خارج\\s*الرسم)\\b[^\\r\\n]{0,80}?(?:[:=]|\\.{2,}|\\s)\\s*(?:[A-Z]{3}|[€$£¥]|د\\.ج\\.?|دج)?\\s*([+-]?(?:[0-9٠-٩]{1,3}(?:[ \\u00A0\\u202F.,'٬][0-9٠-٩]{3})+|[0-9٠-٩]+)(?:[.,٫][0-9٠-٩]{2,4})?)(?!\\s*%)\\s*(?:[A-Z]{3}|[€$£¥]|د\\.ج\\.?|دج)?",
      "group": 1,
      "type": "amount",
      "flags": ["IGNORECASE", "MULTILINE"],
      "many": true,
      "nlp": {
        "use_pos": false,
        "pos_patterns": [],
        "use_ner": true,
        "ner_labels": ["MONEY"],
        "confidence_threshold": 0.0
      },
      "min_confidence": 0.0,
      "apply_post_filters": true,
      "post_filters": [
        "strip_trailing_punct",
        "reject_percent_value",
        "normalize_arabic_indic_digits",
        "normalize_amount_decimal",
        "reject_zero_length"
      ]
    },

    "montant_tva": {
      "rule_id": "INV_AMOUNT_TVA_02",
      "pattern": "(?xim)^\\s*(?:(?:montant|total)\\s*tva|tva(?:\\s*\\([^\\)]{1,20}\\))?|vat\\s*amount|tax\\s*amount|sales\\s*tax|value\\s*added\\s*tax|ضريبة\\s*القيمة\\s*المضافة|مبلغ\\s*الضريبة|قيمة\\s*الضريبة|إجمالي\\s*الضريبة|اجمالي\\s*الضريبة|الضريبة)\\b[^\\r\\n]{0,80}?(?:[:=]|\\.{2,}|\\s)\\s*(?:[A-Z]{3}|[€$£¥]|د\\.ج\\.?|دج)?\\s*([+-]?(?:[0-9٠-٩]{1,3}(?:[ \\u00A0\\u202F.,'٬][0-9٠-٩]{3})+|[0-9٠-٩]+)(?:[.,٫][0-9٠-٩]{2,4})?)(?!\\s*%)\\s*(?:[A-Z]{3}|[€$£¥]|د\\.ج\\.?|دج)?",
      "group": 1,
      "type": "amount",
      "flags": ["IGNORECASE", "MULTILINE"],
      "many": true,
      "nlp": {
        "use_pos": false,
        "pos_patterns": [],
        "use_ner": true,
        "ner_labels": ["MONEY"],
        "confidence_threshold": 0.0
      },
      "min_confidence": 0.0,
      "apply_post_filters": true,
      "post_filters": [
        "strip_trailing_punct",
        "reject_percent_value",
        "normalize_arabic_indic_digits",
        "normalize_amount_decimal",
        "reject_zero_length"
      ]
    },

    "montant_ttc": {
      "rule_id": "INV_AMOUNT_TTC_02",
      "pattern": "(?xim)^\\s*(?:montant\\s*ttc|total\\s*ttc|total\\s*toutes?\\s*taxes\\s*comprises|net\\s*[àa]\\s*payer|total\\s*[àa]\\s*payer|amount\\s*due|balance\\s*due|total\\s*due|grand\\s*total|total\\s*incl(?:\\.?|uding)?\\s*tax|total\\s*including\\s*tax|المبلغ\\s*الإجمالي|المبلغ\\s*الاجمالي|ال(?:إ|ا)جمالي\\s*شامل\\s*الضريبة|المبلغ\\s*شامل\\s*الضريبة|الصافي\\s*للدفع|صافي\\s*الدفع|المبلغ\\s*المستحق|إجمالي\\s*الدفع|اجمالي\\s*الدفع|الواجب\\s*دفعه)\\b[^\\r\\n]{0,100}?(?:[:=]|\\.{2,}|\\s)\\s*(?:[A-Z]{3}|[€$£¥]|د\\.ج\\.?|دج)?\\s*([+-]?(?:[0-9٠-٩]{1,3}(?:[ \\u00A0\\u202F.,'٬][0-9٠-٩]{3})+|[0-9٠-٩]+)(?:[.,٫][0-9٠-٩]{2,4})?)(?!\\s*%)\\s*(?:[A-Z]{3}|[€$£¥]|د\\.ج\\.?|دج)?",
      "group": 1,
      "type": "amount",
      "flags": ["IGNORECASE", "MULTILINE"],
      "many": true,
      "nlp": {
        "use_pos": false,
        "pos_patterns": [],
        "use_ner": true,
        "ner_labels": ["MONEY"],
        "confidence_threshold": 0.0
      },
      "min_confidence": 0.0,
      "apply_post_filters": true,
      "post_filters": [
        "strip_trailing_punct",
        "reject_percent_value",
        "normalize_arabic_indic_digits",
        "normalize_amount_decimal",
        "reject_zero_length"
      ]
    },

    "devise": {
      "rule_id": "INV_CURRENCY_03",
      "pattern": "(?xim)^\\s*(?:(?:devise|currency|monnaie|العملة|عملة)\\b|(?:montant\\s*ttc|total\\s*ttc|net\\s*[àa]\\s*payer|total\\s*[àa]\\s*payer|amount\\s*due|balance\\s*due|total\\s*due|grand\\s*total|المبلغ\\s*الإجمالي|المبلغ\\s*الاجمالي|المبلغ\\s*المستحق|الصافي\\s*للدفع|الواجب\\s*دفعه)\\b)[^\\r\\n]{0,180}?((?:\\b(?:USD|EUR|GBP|JPY|CNY|CHF|CAD|AUD|NZD|SEK|NOK|DKK|SAR|AED|DZD|DA)\\b)|(?:[€$£¥])|(?:\\b(?:euro|euros|dollar|dollars|us\\s*dollar|us\\s*dollars|pound|pounds|pound\\s+sterling|pounds\\s+sterling|sterling|yen|yuan|yuans|dinar|dinars|dinar\\s+alg(?:e|é)rien|dinars\\s+alg(?:e|é)riens|dirham|dirhams|riyal|riyals|rial|rials|franc|francs|swiss\\s+franc|swiss\\s+francs)\\b)|(?:د\\.\\s*ج\\.?|دج)|(?:\\b(?:يورو|دولار|دولارات|دولار\\s+أمريكي|دولار\\s+امريكي|جنيه|جنيهات|جنيه\\s+إسترليني|جنيه\\s+استرليني|ين|يوان|دينار|دنانير|دينار\\s+جزائري|الدينار\\s+الجزائري|درهم|دراهم|ريال|ريالات|فرنك|فرنكات|فرنك\\s+سويسري|فرنكات\\s+سويسرية)\\b))",
      "group": 1,
      "type": "currency",
      "flags": ["IGNORECASE", "MULTILINE"],
      "many": true,
      "nlp": {
        "use_pos": true,
        "pos_patterns": ["CURRENCY_CODE", "CURRENCY_SYMBOL", "CURRENCY_WORD"],
        "use_ner": true,
        "ner_labels": ["CURRENCY", "MONEY"],
        "confidence_threshold": 0.0
      },
      "min_confidence": 0.0,
      "apply_post_filters": true,
      "post_filters": [
        "strip_trailing_punct",
        "normalize_arabic_indic_digits",
        "normalize_currency_code_from_symbol_or_word",
        "normalize_currency_code_from_arabic_word",
        "normalize_da_dj_to_dzd",
        "dedupe_keep_best"
      ]
    }
  },

  "implementation_notes": "V3: devise rendue plus stricte pour reduire la sur-extraction. La regex devise ne cherche plus la monnaie partout dans le document : elle cible d'abord les lignes labelisees (Devise/Currency/Monnaie/العملة) puis les lignes de total TTC / montant du. Support FR/EN/AR pour codes ISO, symboles, noms complets et formes locales DZ (DA, دج, د.ج). Les autres extracteurs restent compatibles FR/EN/AR (dates, montants, numero facture).",
  "selection_hints": {
    "numero_facture": "prefer_first_non_date_like; prefer_alnum_mixed; reject_values_near_purchase_order_labels",
    "date_facture": "prefer_label_invoice_date_or_تاريخ_الفاتورة; prefer_earliest_if_multiple_same_label",
    "date_echeance": "prefer_label_due_date_or_تاريخ_الاستحقاق; prefer_after_doc_date_if_available",
    "montant_ht": "prefer_total_or_subtotal_labels; reject_lines_with_percent_only",
    "montant_tva": "prefer_vat_amount_or_tax_amount_or_ضريبة_القيمة_المضافة; reject_percent_values",
    "montant_ttc": "prefer_total_due_or_total_ttc_or_grand_total_or_المبلغ_الإجمالي",
    "devise": "prefer_labeled_currency_line; else total_ttc_or_amount_due_line; dedupe_per_page_then_per_doc; map_symbols_and_words_to_ISO4217"
  }
}
